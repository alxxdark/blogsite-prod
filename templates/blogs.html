{% extends "base.html" %}

{% block content %}
<style>
  .post-header { border-bottom: 1px solid rgba(255,255,255,0.08); padding-bottom: .75rem; margin-bottom: 1rem; }
  .post-actions { display:flex; gap:.5rem; flex-wrap: wrap; }
  .btn-soft { border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.03); padding:.4rem .7rem; border-radius:.65rem; font-size:.9rem; }
  .btn-soft:hover { background:rgba(255,255,255,0.06); }
  .meta { color: #9aa0a6; font-size:.9rem; }

  /* eski yorum stillerin kalsÄ±n; comments_thread kendi stillerini de getiriyor â€“ Ã§akÄ±ÅŸmaz */
  .comment-card { border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.02); border-radius: .8rem; padding: .9rem; }
  .reply-card { border:1px dashed rgba(255,255,255,0.15); background:rgba(255,255,255,0.02); border-radius:.7rem; padding:.7rem; }
  .reply-indent { margin-left: 1.25rem; }
  .comment-actions { display:flex; gap:.8rem; align-items:center; }
  .link-plain { text-decoration: none; }
  .toggle-reply { cursor:pointer; font-size:.9rem; }
  .badge-pill { border:1px solid rgba(255,255,255,0.16); border-radius:999px; padding:.15rem .55rem; font-size:.75rem; color:#9aa0a6; }
  .divider { height:1px; background:rgba(255,255,255,0.08); margin:1rem 0; }
  @media (max-width: 768px){ .hero-img { max-width: 100% !important; } }
</style>

<div class="container mt-5">
  <!-- BaÅŸlÄ±k + Aksiyonlar -->
  <div class="post-header">
    <h1 class="mb-2">{{ single_blog.title }}</h1>
    <div class="post-actions">
      <!-- Post beÄŸeni -->
      <a id="like-post-btn" class="btn-soft link-plain" href="{% url 'blogs:like_post' single_blog.slug %}">
        ğŸ‘ BeÄŸen (<span id="post-like-count">{{ single_blog.likes.count }}</span>)
      </a>

      <!-- Kaydet / KaldÄ±r -->
      {% if user.is_authenticated %}
        <a id="save-post-btn" class="btn-soft link-plain" href="{% url 'blogs:toggle_save_post' single_blog.slug %}">
          {% if is_saved %}ğŸ’¾ KaydÄ± kaldÄ±r{% else %}ğŸ’¾ Kaydet{% endif %}
        </a>
      {% endif %}

      <!-- GÃ¶rÃ¼ntÃ¼leme -->
      <span class="btn-soft meta">ğŸ‘ï¸ {{ single_blog.view_count }}</span>

      <!-- PaylaÅŸ -->
      {% with page_url=request.build_absolute_uri page_title=single_blog.title %}
        <button class="btn-soft" type="button" onclick="copyLink('{{ page_url|escapejs }}')">ğŸ”— Kopyala</button>
      {% endwith %}
    </div>
  </div>

  <!-- Kapak gÃ¶rseli -->
  {% if single_blog.featured_image %}
    <img src="{{ single_blog.featured_image.url }}" alt="{{ single_blog.title }}"
         class="img-fluid rounded mb-3 hero-img" style="max-width: 820px;">
  {% else %}
    <img src="/static/default-post-image.jpg" alt="Default Image"
         class="img-fluid rounded mb-3 hero-img" style="max-width: 820px;">
  {% endif %}

  <!-- Meta -->
  <p class="meta">Posted by <b>{{ single_blog.author }}</b> on {{ single_blog.created_at }}</p>

  <!-- Ä°Ã§erik -->
  <article class="mb-4">
    {{ single_blog.blog_body|safe }}
  </article>

  <div class="divider"></div>

  <!-- Yorumlar baÅŸlÄ±k -->
  <div class="d-flex align-items-center gap-2 mb-2">
    <h4 class="m-0">Comments</h4>
    <span class="badge-pill" id="comment-count">{{ comment_count }}</span>
  </div>

  <!-- Yorum bÃ¶lÃ¼mÃ¼ -->
  {% include "comments/comments_thread.html" with post=single_blog comments=comments form=form %}

</div>

<script>
  /* CSRF cookie */
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  /* Link kopyalama */
  function copyLink(url){
    if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(url).then(()=> alert("BaÄŸlantÄ± kopyalandÄ±!"));
    } else {
      const t = document.createElement('textarea');
      t.value = url; document.body.appendChild(t); t.select();
      try { document.execCommand('copy'); alert("BaÄŸlantÄ± kopyalandÄ±!"); } catch(e){}
      document.body.removeChild(t);
    }
  }

  /* Post beÄŸeni (AJAX POST) */
  const postLikeBtn = document.getElementById('like-post-btn');
  if (postLikeBtn){
    postLikeBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const url = postLikeBtn.getAttribute('href');
      const res = await fetch(url, {
        method: 'POST',
        headers: {'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrftoken},
      });
      if (res.ok){
        const data = await res.json();
        if (data.ok){
          document.getElementById('post-like-count').textContent = data.likes;
        }
      } else if (res.status === 403){
        window.location.href = "{% url 'login' %}";
      }
    });
  }

  /* Kaydet / KaldÄ±r (AJAX POST) */
  const saveBtn = document.getElementById('save-post-btn');
  if (saveBtn){
    saveBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const url = saveBtn.getAttribute('href');
      const res = await fetch(url, {
        method: 'POST',
        headers: {'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrftoken},
      });
      if (res.ok){
        const data = await res.json();
        if (data.ok){
          saveBtn.textContent = data.saved ? 'ğŸ’¾ KaydÄ± kaldÄ±r' : 'ğŸ’¾ Kaydet';
        }
      } else if (res.status === 403){
        window.location.href = "{% url 'login' %}";
      }
    });
  }
</script>
{% endblock %}
