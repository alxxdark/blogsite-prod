{% extends "base.html" %}

{% block content %}
<style>
  .post-header { border-bottom: 1px solid rgba(255,255,255,0.08); padding-bottom: .75rem; margin-bottom: 1rem; }
  .post-actions { display:flex; gap:.5rem; flex-wrap: wrap; }
  .btn-soft { border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.03); padding:.4rem .7rem; border-radius:.65rem; font-size:.9rem; }
  .btn-soft:hover { background:rgba(255,255,255,0.06); }
  .meta { color: #9aa0a6; font-size:.9rem; }

  .comment-card { border:1px solid rgba(255,255,255,0.12); background:rgba(255,255,255,0.02); border-radius: .8rem; padding: .9rem; }
  .reply-card { border:1px dashed rgba(255,255,255,0.15); background:rgba(255,255,255,0.02); border-radius:.7rem; padding:.7rem; }
  .reply-indent { margin-left: 1.25rem; }
  .comment-actions { display:flex; gap:.8rem; align-items:center; }
  .link-plain { text-decoration: none; }
  .toggle-reply { cursor:pointer; font-size:.9rem; }
  .badge-pill { border:1px solid rgba(255,255,255,0.16); border-radius:999px; padding:.15rem .55rem; font-size:.75rem; color:#9aa0a6; }
  .divider { height:1px; background:rgba(255,255,255,0.08); margin:1rem 0; }

  .root-form .form-text { color:#9aa0a6; }
  .root-form img#preview-img { display:none; max-width:180px; margin-top:8px; border-radius:8px; }
  @media (max-width: 768px){ .hero-img { max-width: 100% !important; } }
</style>

<div class="container mt-5">
  <!-- Ba≈ülƒ±k + Aksiyonlar -->
  <div class="post-header">
    <h1 class="mb-2">{{ single_blog.title }}</h1>
    <div class="post-actions">
      <!-- Post beƒüeni -->
      <a id="like-post-btn" class="btn-soft link-plain" href="{% url 'blogs:like_post' single_blog.slug %}">
        üëç Beƒüen (<span id="post-like-count">{{ single_blog.likes.count }}</span>)
      </a>

      <!-- Kaydet / Kaldƒ±r -->
      {% if user.is_authenticated %}
        <a id="save-post-btn" class="btn-soft link-plain" href="{% url 'blogs:toggle_save_post' single_blog.slug %}">
          {% if is_saved %}üíæ Kaydƒ± kaldƒ±r{% else %}üíæ Kaydet{% endif %}
        </a>
      {% endif %}

      <!-- G√∂r√ºnt√ºleme -->
      <span class="btn-soft meta">üëÅÔ∏è {{ single_blog.view_count }}</span>

      <!-- Payla≈ü -->
      {% with page_url=request.build_absolute_uri page_title=single_blog.title %}
        <button class="btn-soft" type="button" onclick="copyLink('{{ page_url|escapejs }}')">üîó Kopyala</button>
      {% endwith %}
    </div>
  </div>

  <!-- Kapak g√∂rseli -->
  {% if single_blog.featured_image %}
    <img src="{{ single_blog.featured_image.url }}" alt="{{ single_blog.title }}"
         class="img-fluid rounded mb-3 hero-img" style="max-width: 820px;">
  {% else %}
    <img src="/static/default-post-image.jpg" alt="Default Image"
         class="img-fluid rounded mb-3 hero-img" style="max-width: 820px;">
  {% endif %}

  <!-- Meta -->
  <p class="meta">Posted by <b>{{ single_blog.author }}</b> on {{ single_blog.created_at }}</p>

  <!-- ƒ∞√ßerik -->
  <article class="mb-4">
    {{ single_blog.blog_body|safe }}
  </article>

  <div class="divider"></div>

  <!-- Yorumlar ba≈ülƒ±k -->
  <div id="comments"></div>
  <div class="d-flex align-items-center gap-2 mb-2">
    <h4 class="m-0">Comments</h4>
    <span class="badge-pill" id="comment-count">{{ comment_count }}</span>
  </div>

  <!-- ‚ú® K√ñK YORUM FORMU (G√ñRSEL Y√úKLEME) √úSTTE -->
  {% if user.is_authenticated %}
  <form class="root-form mb-4" method="post"
        action="{% url 'blogs:blogs' single_blog.slug %}#comments"
        enctype="multipart/form-data">
    {% csrf_token %}
    <div class="mb-3">
      <label for="id_comment" class="form-label">Yorumunuz</label>
      <textarea id="id_comment" name="comment" class="form-control" rows="4" placeholder="Yorumunuzu yazƒ±n..."></textarea>
    </div>

    <div class="mb-3">
      <label for="id_image" class="form-label">G√∂rsel ekle (opsiyonel)</label>
      <input type="file" class="form-control" id="id_image" name="image"
             accept="image/png,image/jpeg,image/webp,image/gif">
      <div class="form-text">PNG, JPG, WEBP, GIF ‚Äî en fazla 5MB.</div>
      <img id="preview-img" alt="√ñnizleme">
    </div>

    <button type="submit" class="btn btn-warning">Yorum Yap</button>
  </form>
  {% else %}
    <div class="alert alert-info">Yorum yapmak i√ßin <a href="{% url 'login' %}">giri≈ü yapƒ±n</a>.</div>
  {% endif %}

  <!-- Mevcut yorumlar + yanƒ±t formlarƒ± (bu sayfadaki k√∂k yorumlar) -->
  {% include "comments/comments_thread.html" with post=single_blog comments=comments form=form %}

  <!-- SAYFALAMA -->
  {% if c_page_obj and c_page_obj.has_other_pages %}
    <nav class="mt-3" aria-label="Comments pagination">
      <ul class="pagination justify-content-center">
        {% if c_page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?cpage={{ c_page_obj.previous_page_number }}#comments">Previous</a>
          </li>
        {% endif %}
        {% for p in c_page_obj.paginator.page_range %}
          {% if p == c_page_obj.number %}
            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
          {% elif p >= c_page_obj.number|add:'-2' and p <= c_page_obj.number|add:'2' %}
            <li class="page-item"><a class="page-link" href="?cpage={{ p }}#comments">{{ p }}</a></li>
          {% endif %}
        {% endfor %}
        {% if c_page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?cpage={{ c_page_obj.next_page_number }}#comments">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>

<script>
  /* CSRF cookie */
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  /* Link kopyalama */
  function copyLink(url){
    if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(url).then(()=> alert("Baƒülantƒ± kopyalandƒ±!"));
    } else {
      const t = document.createElement('textarea');
      t.value = url; document.body.appendChild(t); t.select();
      try { document.execCommand('copy'); alert("Baƒülantƒ± kopyalandƒ±!"); } catch(e){}
      document.body.removeChild(t);
    }
  }

  /* Post beƒüeni (AJAX POST) */
  const postLikeBtn = document.getElementById('like-post-btn');
  if (postLikeBtn){
    postLikeBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const url = postLikeBtn.getAttribute('href');
      const res = await fetch(url, {
        method: 'POST',
        headers: {'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrftoken},
      });
      if (res.ok){
        const data = await res.json();
        if (data.ok){
          document.getElementById('post-like-count').textContent = data.likes;
        }
      } else if (res.status === 403){
        window.location.href = "{% url 'login' %}";
      }
    });
  }

  /* Kaydet / Kaldƒ±r (AJAX POST) */
  const saveBtn = document.getElementById('save-post-btn');
  if (saveBtn){
    saveBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const url = saveBtn.getAttribute('href');
      const res = await fetch(url, {
        method: 'POST',
        headers: {'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrftoken},
      });
      if (res.ok){
        const data = await res.json();
        if (data.ok){
          saveBtn.textContent = data.saved ? 'üíæ Kaydƒ± kaldƒ±r' : 'üíæ Kaydet';
        }
      } else if (res.status === 403){
        window.location.href = "{% url 'login' %}";
      }
    });
  }

  /* G√∂rsel √∂nizleme (k√∂k yorum formu) */
  (function(){
    const fileInput = document.getElementById('id_image');
    const preview   = document.getElementById('preview-img');
    if (!fileInput || !preview) return;
    fileInput.addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      if (!f || !/^image\//.test(f.type)) { preview.style.display='none'; preview.src=''; return; }
      preview.src = URL.createObjectURL(f);
      preview.style.display = 'block';
    });
  })();
</script>
{% endblock %}
